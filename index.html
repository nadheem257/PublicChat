<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ultimate WhatsApp-Style Chat</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/emojionearea/3.4.1/emojionearea.min.css"/>
<style>
@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap');

body {
    margin:0; font-family: 'Roboto', sans-serif; background:#ece5dd; display:flex; justify-content:center; align-items:center; height:100vh; overflow:hidden;
}
#chatApp {
    display:flex; width:95%; max-width:1200px; height:85%; background:#fff; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.2); overflow:hidden;
}

/* Left Sidebar - Rooms */
#leftSidebar {
    width:250px; background:#ededed; display:flex; flex-direction:column; border-right:1px solid #ccc;
}
#leftSidebar h2 { margin:10px; font-size:20px; text-align:center; }
#rooms { flex:1; overflow-y:auto; padding:5px; }
.room { padding:10px; margin:5px 0; background:#fff; border-radius:5px; cursor:pointer; transition:0.3s; text-align:center; }
.room:hover { background:#0af; color:white; }
.room.active { background:#075e54; color:white; font-weight:bold; }
#createGroupBtn { margin:10px; padding:8px; font-size:16px; border:none; border-radius:8px; cursor:pointer; background:#075e54; color:white; }
#createGroupBtn:hover { background:#128c7e; }

/* Right Sidebar - Online Users */
#rightSidebar {
    width:200px; background:#ededed; display:flex; flex-direction:column; border-left:1px solid #ccc;
}
#rightSidebar h2 { margin:10px; font-size:18px; text-align:center; }
#usersList { flex:1; overflow-y:auto; padding:5px; font-size:16px; }
.user { padding:5px 10px; margin:3px 0; background:#fff; border-radius:5px; }

/* Chat area */
#chatArea {
    flex:1; display:flex; flex-direction:column; background:#f0f0f0;
}
#chatHeader {
    padding:15px; background:#075e54; color:white; font-size:22px; font-weight:bold; text-shadow:1px 1px 2px #000;
}
#chatMessages { flex:1; padding:15px; overflow-y:auto; display:flex; flex-direction:column; }
.bubble {
    max-width:60%; padding:12px 18px; margin:5px 0; border-radius:20px; animation: fadeIn 0.3s; word-wrap: break-word; font-size:16px;
    font-weight:500; letter-spacing:0.5px; text-shadow:0px 1px 2px rgba(0,0,0,0.2);
}
.bubble-you { background:#dcf8c6; align-self:flex-end; border-bottom-right-radius:0; color:#000; }
.bubble-friend { background:#fff; align-self:flex-start; border-bottom-left-radius:0; color:#000; }
#typing { font-size:14px; color:#555; margin:5px 15px; height:18px; font-style:italic; }

/* Input area */
#chatInput { display:flex; padding:10px; background:#eee; border-top:1px solid #ccc; align-items:center; }
#chatInput input[type="text"] { flex:1; padding:12px 15px; border-radius:25px; border:none; font-size:16px; margin-right:10px; }
#chatInput button { padding:12px 15px; border:none; border-radius:25px; background:#075e54; color:white; cursor:pointer; font-size:16px; transition:0.3s; margin-right:5px; }
#chatInput button:hover { background:#128c7e; }

/* Login overlay */
#loginOverlay {
    position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:10;
}
#loginOverlay input { padding:12px; font-size:18px; border-radius:8px; border:none; margin-bottom:10px; width:250px; }
#loginOverlay button { padding:12px 25px; font-size:18px; border:none; border-radius:8px; background:#075e54; color:white; cursor:pointer; }
#loginOverlay button:hover { background:#128c7e; }

@keyframes fadeIn { from {opacity:0; transform: translateY(10px);} to {opacity:1; transform: translateY(0);} }

img.chat-image { max-width:200px; border-radius:15px; margin-top:5px; }
</style>
</head>
<body>

<div id="chatApp">
    <!-- Left Sidebar -->
    <div id="leftSidebar">
        <h2>Rooms</h2>
        <button class="room active" data-room="room1">Public Temporary Chat</button>
        <button id="createGroupBtn">+ Create Group</button>
        <div id="rooms"></div>
    </div>

    <!-- Chat Area -->
    <div id="chatArea">
        <div id="chatHeader">Public Temporary Chat</div>
        <div id="chatMessages"></div>
        <div id="typing"></div>
        <div id="chatInput">
            <button id="attachBtn">ðŸ“Ž</button>
            <button id="emojiBtn">ðŸ˜Š</button>
            <input type="text" id="msgInput" placeholder="Type a message...">
            <button id="sendBtn">Send</button>
            <input type="file" id="fileInput" style="display:none;">
        </div>
    </div>

    <!-- Right Sidebar -->
    <div id="rightSidebar">
        <h2>Online Users</h2>
        <div id="usersList"></div>
    </div>
</div>

<!-- Login Overlay -->
<div id="loginOverlay">
    <h2 style="color:white;">Enter Your Name</h2>
    <input id="nameInput" placeholder="Your name...">
    <button id="loginBtn">Join Chat</button>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/emojionearea/3.4.1/emojionearea.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function(){
    const firebaseConfig = {
      apiKey: "AIzaSyCwSqm65CoNwPc3PiVo1T40YJM2MAcg480",
      authDomain: "server-1-9fa4f.firebaseapp.com",
      databaseURL: "https://server-1-9fa4f-default-rtdb.firebaseio.com",
      projectId: "server-1-9fa4f",
      storageBucket: "server-1-9fa4f.firebasestorage.app",
      messagingSenderId: "1019529146427",
      appId: "1:1019529146427:web:e22f6bbe1623b528f6ec1e"
    };
    firebase.initializeApp(firebaseConfig);

    let db = firebase.database();
    let userId = "user-"+Math.floor(Math.random()*100000);
    let userName = "";
    let currentRoom = "room1";
    let typingTimeout;
    let tempMessages = []; // store temporary messages for Public Temporary Chat

    // DOM
    let loginOverlay = document.getElementById("loginOverlay");
    let nameInput = document.getElementById("nameInput");
    let loginBtn = document.getElementById("loginBtn");
    let msgInput = document.getElementById("msgInput");
    let sendBtn = document.getElementById("sendBtn");
    let chatMessages = document.getElementById("chatMessages");
    let typingIndicator = document.getElementById("typing");
    let usersList = document.getElementById("usersList");
    let chatHeader = document.getElementById("chatHeader");
    let roomsDiv = document.getElementById("rooms");
    let createGroupBtn = document.getElementById("createGroupBtn");
    let attachBtn = document.getElementById("attachBtn");
    let fileInput = document.getElementById("fileInput");

    // Emoji picker
    $(function() {
        $("#msgInput").emojioneArea({ pickerPosition: "top", tonesStyle: "bullet" });
    });

    function addMessage(content, cls, isImage=false){
        let div = document.createElement("div");
        div.className = "bubble "+cls;
        if(isImage){
            let img = document.createElement("img");
            img.src = content;
            img.className = "chat-image";
            div.appendChild(img);
        } else {
            div.innerText = content;
        }
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Update Rooms
    function updateRooms(){
        db.ref("rooms").once("value", snap=>{
            roomsDiv.innerHTML = "";
            let data = snap.val() || {};
            Object.keys(data).forEach(r=>{
                let div = document.createElement("div");
                div.className = "room";
                if(r===currentRoom) div.classList.add("active");
                div.innerText = data[r].name;
                div.dataset.room = r;
                div.addEventListener("click", ()=>{
                    currentRoom = r;
                    chatHeader.innerText = data[r].name;
                    chatMessages.innerHTML = "";
                    if(currentRoom==="room1") renderTempMessages();
                    listenMessages();
                    updateUsersList();
                    document.querySelectorAll(".room").forEach(rr=>rr.classList.remove("active"));
                    div.classList.add("active");
                });
                roomsDiv.appendChild(div);
            });
        });
    }

    createGroupBtn.addEventListener("click", ()=>{
        let gname = prompt("Enter group name:");
        if(!gname) return;
        let id = "room"+Date.now();
        db.ref("rooms/"+id).set({name:gname});
        updateRooms();
    });

    loginBtn.addEventListener("click", ()=>{
        let name = nameInput.value.trim();
        if(!name){ alert("Enter a name"); return; }
        userName = name;
        loginOverlay.style.display = "none";
        if(currentRoom!=="room1"){
            db.ref(currentRoom+"-users/"+userId).set({name:userName});
            db.ref(currentRoom+"-users/"+userId).onDisconnect().remove();
        }
        updateRooms();
        listenMessages();
        updateUsersList();
    });

    function sendMessage(text, isImage=false){
        if(!text) return;

        if(currentRoom==="room1"){
            tempMessages.push({text, user:userId, name:userName, isImage});
            renderTempMessages();
        } else {
            db.ref(currentRoom).push({text, user:userId, name:userName, time:Date.now(), isImage});
        }

        if(!isImage) $("#msgInput").data("emojioneArea").setText('');
    }

    function renderTempMessages(){
        chatMessages.innerHTML = "";
        tempMessages.forEach(m=>{
            let cls = (m.user===userId) ? "bubble-you" : "bubble-friend";
            let displayName = (m.user===userId) ? "You" : m.name||"Friend";
            if(m.isImage){
                addMessage(m.text, cls, true);
            } else {
                addMessage(displayName+": "+m.text, cls);
            }
        });
    }

    sendBtn.addEventListener("click", ()=> sendMessage($("#msgInput").data("emojioneArea").getText()));

    msgInput.addEventListener("keypress", e=>{
        if(e.key==="Enter"){ sendMessage($("#msgInput").data("emojioneArea").getText()); }
        if(currentRoom!=="room1"){
            db.ref(currentRoom+"-typing").set({user:userName});
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(()=> db.ref(currentRoom+"-typing").remove(), 1000);
        }
    });

    attachBtn.addEventListener("click", ()=> fileInput.click());
    fileInput.addEventListener("change", function(){
        let file = fileInput.files[0];
        if(file && file.type.startsWith("image/")){
            let reader = new FileReader();
            reader.onload = function(e){
                sendMessage(e.target.result, true);
            }
            reader.readAsDataURL(file);
        }
    });

    function listenMessages(){
        if(currentRoom==="room1") return; // Room1 is temporary, no Firebase listening

        db.ref(currentRoom).off();
        db.ref(currentRoom).on("child_added", snap=>{
            let data = snap.val();
            if(data){
                let cls = (data.user===userId) ? "bubble-you" : "bubble-friend";
                let displayName = (data.user===userId) ? "You" : data.name||"Friend";
                if(data.isImage){
                    addMessage(data.text, cls, true);
                } else {
                    addMessage(displayName+": "+data.text, cls);
                }
            }
        });

        db.ref(currentRoom+"-typing").on("value", snap=>{
            let val = snap.val();
            if(val && val.user!==userName){
                typingIndicator.innerText = val.user+" is typing...";
            } else { typingIndicator.innerText = ""; }
        });
    }

    function updateUsersList(){
        if(currentRoom==="room1") {
            usersList.innerHTML = "Everyone";
            return;
        }
        db.ref(currentRoom+"-users").on("value", snap=>{
            let users = snap.val() || {};
            usersList.innerHTML = Object.values(users).map(u=>u.name).join("<br>");
        });
    }

});
</script>
</body>
</html>
