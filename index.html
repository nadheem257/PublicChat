<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Chatables with Custom Cursor</title>

<!-- EmojiOneArea CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/emojionearea/3.4.1/emojionearea.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">


<style>
/* ---------------- Chatables Styles ---------------- */
body {
  margin: 0;
  font-family:'Inter',sans-serif;
  background:#05050a;
  color:white;
  overflow:hidden;
  cursor: none; /* hide default cursor */
}
*{box-sizing:border-box;}
#bg{
  position:fixed; inset:0;
  background:linear-gradient(270deg,#05050a,#0a0c1a,#05050a);
  background-size:600% 600%;
  animation:bgcolors 20s ease infinite;
  z-index:-1;
}
@keyframes bgcolors{0%,100%{background-position:0% 50%;}50%{background-position:100% 50%;}}
.particle{position:absolute;width:7px;height:7px;background:#00ffffdd;border-radius:50%;
box-shadow:0 0 5px #00ffffcc,0 0 18px #00eaffcc,0 0 40px #00c8ff99;
animation:float 8s ease-in-out infinite; opacity:.85;}
@keyframes float{0%{transform:translateY(0) scale(.75);}50%{transform:translateY(-120px) scale(1.7);}100%{transform:translateY(0) scale(.75);}}
.screen { display: none; flex-direction: column; justify-content: center; align-items: center; height: 100vh; margin: 10px; animation:fadein 1.2s ease forwards; background:rgba(0,224,255,0.04); backdrop-filter:blur(24px); box-shadow: inset 0 0 130px #00eaff77; border-radius:15px; }
#loginChoice { display:flex; gap:20px; flex-direction: column; align-items:center; }
@keyframes fadein{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);} }
.title{font-size:42px;font-weight:900;color:#00eaff;text-shadow:0 0 30px #00eaff;padding-bottom:18px;animation:neonFlicker 2s infinite;}
@keyframes neonFlicker{0%,100%{opacity:1;}50%{opacity:.75;}}
input,button{font-family:'Inter',sans-serif;border-radius:10px;outline:none;border:none;padding:12px 16px;font-size:16px;}
input{background:#0c0c14;color:white;border:2px solid #26263a;text-align:center;width:300px;margin:8px;transition:.3s;}
input:focus{border-color:#00eaff;box-shadow:0 0 20px #00eaffcc;animation:pulseBorder 2s infinite;}
@keyframes pulseBorder{0%,100%{box-shadow:0 0 10px #26263a;}50%{box-shadow:0 0 25px #00eaff;}}
button{cursor:pointer;font-weight:700;color:#000;background:linear-gradient(45deg,#00eaff,#00ffaa);padding:14px 20px;font-size:18px;margin-top:8px;border-radius:16px;text-shadow:0 0 9px #00ffec;box-shadow:0 0 45px #00ffaaaa;transition:.4s;animation:buttonGlow 3s infinite;}
button:hover{transform:scale(1.15);box-shadow:0 0 90px #00fff7ee;}
@keyframes buttonGlow{0%,100%{box-shadow:0 0 25px #00ffcc;}50%{box-shadow:0 0 60px #00ffff;}}
#chatScreen { 
    display:flex; 
    flex-direction:column; 
    padding:20px; 
    height:100vh; 
    background:rgba(7,10,18,.88); 
    backdrop-filter:blur(28px); 
    border-radius:18px; 
    box-shadow:inset 0 0 130px #00ffffaa; 
    position: relative; /* For settings button positioning */
}
#messages { flex:1; overflow-y:auto; padding:14px; border-radius:16px; border:1px solid #1b1b2d; background: rgba(7,10,18,0.9); scroll-behavior:smooth; box-shadow:0 6px 40px #00eaffdd; }

/* Modified chat-row to include profile pic */
.chat-row { 
    display: flex; 
    align-items: flex-start; /* Align to the top of the bubble */
    margin: 14px 0; 
    animation: msgEnter .5s ease; 
}
.chat-row.you { justify-content: flex-end; } /* Align your messages to the right */
.chat-row.friend { justify-content: flex-start; } /* Align friend messages to the left */

@keyframes msgEnter{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
.chat-bubble { 
    padding:16px 22px; 
    max-width:65%; 
    border-radius:20px; 
    font-size:16px; 
    transition:.3s; 
    box-shadow:0 5px 20px #00ffff55; 
    display: flex;
    flex-direction: column;
}
.message-you { background:linear-gradient(135deg,#22ff9c,#00b36f); color:black; animation:glowBubble 2s infinite; border-bottom-right-radius: 4px; /* Adjust for profile pic */ }
.message-friend { background:linear-gradient(135deg,#3f95ff,#1d63dd); color:white; animation:glowBubble 2s infinite; border-bottom-left-radius: 4px; /* Adjust for profile pic */ }
@keyframes glowBubble{0%,100%{box-shadow:0 0 15px #00ffcc;}50%{box-shadow:0 0 35px #00ffff;}}
.timestamp { font-size:12px; opacity:0.7; margin-left:6px; color:black; text-shadow:none; }
.input-area{display:flex;gap:12px;margin-top:18px;align-items:center;position:relative;}
#msg{flex:1;padding:16px;border:2px solid #26263a;background:#0b0b15;color:white;border-radius:18px;font-size:17px;box-shadow:inset 0 0 15px #10ffffcc;}
#sendBtn{background:linear-gradient(45deg,#00eaff,#00fff7); color:black; font-weight:700; box-shadow:0 0 25px #00fff7aa;}
#sendBtn:hover{transform:scale(1.1);box-shadow:0 0 50px #00fff7ee;}
#clearBtn{margin-top:12px;width:100%;padding:16px;background:#ff3366;color:white;border-radius:18px;transition:.35s;}
#clearBtn:hover{transform:scale(1.1);box-shadow:0 0 55px #ff5580cc;}
#onlineUsers{margin-top:12px;padding:12px;background:rgba(0,255,255,.15);border-radius:14px;font-size:15px;max-height:180px;overflow-y:auto;}
/* Modified online-user to include profile pic */
.online-user{display:flex;align-items:center;gap:12px;margin:6px 0;padding:8px 14px;border-radius:12px;opacity:0;animation:popOnline .5s forwards;}
.online-user.self{background:#00ff9f55;font-weight:800;}
.online-dot{width:12px;height:12px;border-radius:50%;background:#0f0;box-shadow:0 0 10px #0f0aa;animation:pulseDot 1.5s infinite;}
@keyframes popOnline{from{opacity:0;transform:scale(.85);}to{opacity:1;transform:scale(1);}}
@keyframes pulseDot{0%,100%{transform:scale(0.85);}50%{transform:scale(1.3);}}
.info-link { margin-top:10px; font-size:13px; color:#00eaff; cursor:pointer; text-decoration:underline; }
.info-link:hover { color:#00ffaa; }

/* New Profile Picture, Nametag, and Effects Styles */
.profile-pic {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    margin: 0 10px; /* Space around profile pics */
    border: 2px solid transparent;
    transition: all 0.3s ease;
    flex-shrink: 0; /* Prevent shrinking in flex container */
    box-shadow: 0 0 10px rgba(0,255,255,0.4);
}
.chat-row.friend .profile-pic { margin-right: 10px; margin-left: 0; }
.chat-row.you .profile-pic { order: 2; margin-left: 10px; margin-right: 0; } /* Order for your profile pic */

.online-user .profile-pic {
    width: 30px;
    height: 30px;
    margin: 0;
    box-shadow: 0 0 8px rgba(0,255,255,0.3);
}

.nametag {
    font-weight: bold;
    margin-right: 8px;
    display: flex;
    align-items: center;
    gap: 5px;
}

/* Default nametag colors (can be overridden by user choice) */
.nametag-default-you { color: #007bff; }
.nametag-default-friend { color: #28a745; }

/* Example Profile Effects */
.profile-pic.effect-sparkle {
    border-color: gold;
    box-shadow: 0 0 15px gold, 0 0 25px rgba(255,215,0,0.6);
    animation: sparkleEffect 1.5s infinite alternate;
}
@keyframes sparkleEffect {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.05); opacity: 0.9; box-shadow: 0 0 20px gold, 0 0 35px rgba(255,215,0,0.8); }
    100% { transform: scale(1); opacity: 1; }
}

.profile-pic.effect-aura {
    box-shadow: 0 0 10px #00eaff, 0 0 20px #00eaff, 0 0 30px #00eaff;
    animation: auraEffect 2s infinite ease-in-out;
}
@keyframes auraEffect {
    0% { box-shadow: 0 0 10px #00eaff, 0 0 20px #00eaff, 0 0 30px #00eaff; }
    50% { box-shadow: 0 0 15px #00ffaa, 0 0 25px #00ffaa, 0 0 40px #00ffaa; }
    100% { box-shadow: 0 0 10px #00eaff, 0 0 20px #00eaff, 0 0 30px #00eaff; }
}

/* User options for Public Screen and Settings Screen */
.profile-options {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: 15px;
    gap: 10px;
}
.profile-option-group {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
    margin-bottom: 10px;
}
.profile-option-group label {
    font-size: 14px;
    color: #00eaff;
    margin-right: 5px;
}
.profile-pic-preview {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #00eaff;
    margin-bottom: 10px;
    box-shadow: 0 0 15px #00eaffcc;
}
.color-swatch {
    width: 25px;
    height: 25px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    transition: border-color 0.2s ease;
}
.color-swatch.selected {
    border-color: #00eaff;
    box-shadow: 0 0 10px #00eaff;
}
.effect-preview {
    padding: 8px 12px;
    border: 1px solid #00eaff;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s ease, border-color 0.2s ease;
    font-size: 14px;
}
.effect-preview.selected {
    background-color: #00eaff33;
    border-color: #00ffaa;
    box-shadow: 0 0 10px #00ffaa;
}

/* Settings button in chat screen */
#settingsBtn {
    position: absolute;
    top: 20px;
    right: 20px;
    padding: 10px 15px;
    font-size: 16px;
    background: linear-gradient(45deg, #00eaff, #00ffaa);
    color: black;
    border-radius: 12px;
    cursor: pointer;
    z-index: 10;
    box-shadow: 0 0 20px rgba(0,255,255,0.6);
}
#settingsBtn:hover {
    transform: scale(1.05);
    box-shadow: 0 0 30px rgba(0,255,255,0.8);
}

/* Settings Screen */
#settingsScreen {
    display: none; /* Hidden by default */
    padding: 20px;
    height: 100vh;
    background:rgba(7,10,18,.88); 
    backdrop-filter:blur(28px); 
    border-radius:18px; 
    box-shadow:inset 0 0 130px #00ffffaa;
    overflow-y: auto; /* Allow scrolling if options are many */
}
#settingsScreen .title {
    margin-bottom: 20px;
}
#settingsScreen .profile-options {
    margin-top: 0; /* Adjust spacing */
}
#settingsScreen button {
    margin-top: 15px;
    width: 100%; /* Full width buttons for settings actions */
    max-width: 300px;
}

/* ---------------- Custom Cursor Styles ---------------- */
.cursor-target { padding: 14px 20px; user-select: none; cursor:pointer; border: 3px solid transparent; position: relative; transition: background 0.3s, border-color 0.3s; }
.target-cursor-wrapper { position: fixed; top:0; left:0; width:0; height:0; pointer-events:none; z-index:9999; mix-blend-mode:difference; transform:translate(-50%, -50%); }
.target-cursor-dot { position:absolute; left:50%; top:50%; width:4px; height:4px; background:#fff; border-radius:50%; transform:translate(-50%, -50%); will-change:transform; }
.target-cursor-corner { position:absolute; left:50%; top:50%; width:12px; height:12px; border:3px solid #fff; background:transparent; will-change:transform; box-sizing:border-box; }
.corner-tl { transform:translate(-150%, -150%); border-right:none; border-bottom:none; }
.corner-tr { transform:translate(50%, -150%); border-left:none; border-bottom:none; }
.corner-br { transform:translate(50%, 50%); border-left:none; border-top:none; }
.corner-bl { transform:translate(-150%, 50%); border-right:none; border-top:none; }
</style>
</head>

<body>
<div id="bg"></div>

<!-- ---------------- Screens ---------------- -->
<div id="loginChoice" class="screen">
  <div class="title">CHATABLES</div>
  <button id="privateBtn" class="cursor-target">Private Chat Login</button>
  <button id="publicBtn" class="cursor-target">Public Chat</button>
</div>

<div id="loginScreen" class="screen">
  <div class="title">CHATABLES</div>
  <input id="username" placeholder="Username" class="cursor-target">
  <input id="password" placeholder="Password" type="password" class="cursor-target">
  <button id="loginPrivateBtn" class="cursor-target">Enter Chat ðŸš€</button>
  <div class="info-link cursor-target" onclick="showInfo()">Need a personal account?</div>
</div>

<div id="infoScreen" class="screen" style="display:none; text-align:center; padding:20px;">
  <div class="title">Personal Account Info</div>
  <p>If you need a personal account to chat, you must ask the admin in person. Only IISS members can get an account.</p>
  <button onclick="backToLogin()" class="cursor-target">Back</button>
</div>

<div id="publicScreen" class="screen">
  <div class="title">CHATABLES</div>
  <input id="publicName" placeholder="Enter your name" class="cursor-target">
  
  <div class="profile-options">
      <img id="publicProfilePicPreview" src="https://via.placeholder.com/60/00eaff/000000?text=P" alt="Profile" class="profile-pic-preview">
      <div class="profile-option-group">
          <label>Profile Picture URL:</label>
          <input id="publicProfilePicUrl" placeholder="Image URL (optional)" value="https://via.placeholder.com/60/00eaff/000000?text=P" class="cursor-target" style="width:250px;">
      </div>
      <div class="profile-option-group">
          <label>Nametag Color:</label>
          <div class="color-swatch public-color-swatch selected" style="background-color:#00eaff;" data-color="#00eaff"></div>
          <div class="color-swatch public-color-swatch" style="background-color:#00ffaa;" data-color="#00ffaa"></div>
          <div class="color-swatch public-color-swatch" style="background-color:#ff00ea;" data-color="#ff00ea"></div>
          <div class="color-swatch public-color-swatch" style="background-color:#fff;" data-color="#fff"></div>
      </div>
      <div class="profile-option-group">
          <label>Profile Effect:</label>
          <div class="effect-preview public-effect-preview selected" data-effect="none">None</div>
          <div class="effect-preview public-effect-preview" data-effect="sparkle">Sparkle</div>
          <div class="effect-preview public-effect-preview" data-effect="aura">Aura</div>
      </div>
  </div>

  <button id="loginPublicBtn" class="cursor-target">Enter Chat ðŸš€</button>
</div>

<div id="chatScreen">
  <div class="title">CHATABLES</div>
  <button id="settingsBtn" class="cursor-target">Settings</button>
  <div id="messages"></div>
  <div class="input-area">
    <input id="msg" placeholder="Type a message..." class="cursor-target">
    <button id="sendBtn" class="cursor-target">Send</button>
  </div>
  <button id="clearBtn" class="cursor-target">Clear Chat</button>
  <div id="onlineUsers"></div>
</div>

<!-- Settings Screen -->
<div id="settingsScreen" class="screen">
    <div class="title">SETTINGS</div>
    <div class="profile-options">
        <img id="settingsProfilePicPreview" src="https://via.placeholder.com/60/00eaff/000000?text=P" alt="Profile" class="profile-pic-preview">
        <div class="profile-option-group">
            <label>Profile Picture URL:</label>
            <input id="settingsProfilePicUrl" placeholder="Image URL (optional)" class="cursor-target" style="width:250px;">
        </div>
        <div class="profile-option-group">
            <label>Nametag Color:</label>
            <div class="color-swatch settings-color-swatch selected" style="background-color:#00eaff;" data-color="#00eaff"></div>
            <div class="color-swatch settings-color-swatch" style="background-color:#00ffaa;" data-color="#00ffaa"></div>
            <div class="color-swatch settings-color-swatch" style="background-color:#ff00ea;" data-color="#ff00ea"></div>
            <div class="color-swatch settings-color-swatch" style="background-color:#fff;" data-color="#fff"></div>
        </div>
        <div class="profile-option-group">
            <label>Profile Effect:</label>
            <div class="effect-preview settings-effect-preview selected" data-effect="none">None</div>
            <div class="effect-preview settings-effect-preview" data-effect="sparkle">Sparkle</div>
            <div class="effect-preview settings-effect-preview" data-effect="aura">Aura</div>
        </div>
    </div>
    <button id="saveSettingsBtn" class="cursor-target">Save Settings</button>
    <button id="cancelSettingsBtn" class="cursor-target" style="background:#888; color:white;">Back to Chat</button>
</div>


<!-- ---------------- Custom Cursor HTML ---------------- -->
<div class="target-cursor-wrapper">
  <div class="target-cursor-dot"></div>
  <div class="target-cursor-corner corner-tl"></div>
  <div class="target-cursor-corner corner-tr"></div>
  <div class="target-cursor-corner corner-br"></div>
  <div class="target-cursor-corner corner-bl"></div>
</div>

<!-- ---------------- Scripts ---------------- -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/emojionearea/3.4.1/emojionearea.min.js"></script>

<script>
// ---------------- Firebase Chat ----------------
firebase.initializeApp({
  apiKey:"AIzaSyCwSqm65CoNwPc3PiVo1T40YJM2MAcg480",
  authDomain:"server-1-9fa4f.firebaseapp.com",
  databaseURL:"https://server-1-9fa4f-default-rtdb.firebaseio.com",
  projectId:"server-1-9fa4f",
  storageBucket:"server-1-9fa4f.appspot.com",
  messagingSenderId:"1019529146427",
  appId:"1:1019529146427:web:e22f6bbe1623b528f6ec1e"
});

const db=firebase.database();
let userId="", username="", chatType="", privateRoom="";
// Enhanced validUsers to include profilePic, nametagColor, and effect
const validUsers={
    "Fdr_Hid": { password: "Nadheem2011", profilePic: "https://via.placeholder.com/60/FF5733/FFFFFF?text=FH", nametagColor: "#FF5733", effect: "sparkle" },
    "_Ash_": { password: "Ash2011", profilePic: "https://via.placeholder.com/60/33FF57/FFFFFF?text=AS", nametagColor: "#33FF57", effect: "aura" },
    "NobodyCanBeatMe": { password: "Junaid2011", profilePic: "https://via.placeholder.com/60/3357FF/FFFFFF?text=NB", nametagColor: "#3357FF", effect: "none" },
    "Itsmethekingoftheworld": { password: "Jay@2011", profilePic: "https://via.placeholder.com/60/FF33DA/FFFFFF?text=IK", nametagColor: "#FF33DA", effect: "sparkle" }
};

// Default values for public chat
let userProfilePic = "https://via.placeholder.com/60/00eaff/000000?text=P"; 
let userNametagColor = "#00eaff"; 
let userEffect = "none"; 

const loginChoice=document.getElementById("loginChoice");
const loginScreen=document.getElementById("loginScreen");
const infoScreen=document.getElementById("infoScreen");
const publicScreen=document.getElementById("publicScreen");
const chatScreen=document.getElementById("chatScreen"); // Renamed to avoid conflict
const settingsScreen=document.getElementById("settingsScreen"); // New settings screen

function showInfo(){ loginScreen.style.display="none"; infoScreen.style.display="flex"; }
function backToLogin(){ infoScreen.style.display="none"; loginScreen.style.display="flex"; }

document.getElementById("privateBtn").onclick=()=>{loginChoice.style.display="none"; loginScreen.style.display="flex";}
document.getElementById("publicBtn").onclick=()=>{
    loginChoice.style.display="none"; 
    publicScreen.style.display="flex";
    
    // Load saved public chat data from localStorage
    const savedName = localStorage.getItem('publicUsername');
    const savedPic = localStorage.getItem('publicProfilePic');
    const savedColor = localStorage.getItem('publicNametagColor');
    const savedEffect = localStorage.getItem('publicEffect');

    if (savedName) {
        document.getElementById("publicName").value = savedName;
        username = savedName; // Pre-set username
    }
    if (savedPic) {
        userProfilePic = savedPic;
    }
    if (savedColor) {
        userNametagColor = savedColor;
    }
    if (savedEffect) {
        userEffect = savedEffect;
    }

    // Initialize public profile options with loaded or default values
    updateProfileOptionsUI("public", userProfilePic, userNametagColor, userEffect);
}

// Function to update profile options UI for a given screen (public or settings)
function updateProfileOptionsUI(screenPrefix, picUrl, nametagColor, effect) {
    document.getElementById(`${screenPrefix}ProfilePicUrl`).value = picUrl;
    document.getElementById(`${screenPrefix}ProfilePicPreview`).src = picUrl;
    document.querySelectorAll(`.${screenPrefix}-color-swatch`).forEach(swatch => {
        if (swatch.dataset.color === nametagColor) swatch.classList.add("selected");
        else swatch.classList.remove("selected");
    });
    document.querySelectorAll(`.${screenPrefix}-effect-preview`).forEach(effectBtn => {
        if (effectBtn.dataset.effect === effect) effectBtn.classList.add("selected");
        else effectBtn.classList.remove("selected");
    });
}


// Event listeners for public profile options
document.getElementById("publicProfilePicUrl").addEventListener("input", function() {
    const url = this.value.trim();
    userProfilePic = url || "https://via.placeholder.com/60/00eaff/000000?text=P";
    document.getElementById("publicProfilePicPreview").src = userProfilePic;
});

document.querySelectorAll(".public-color-swatch").forEach(swatch => {
    swatch.addEventListener("click", function() {
        document.querySelectorAll(".public-color-swatch").forEach(s => s.classList.remove("selected"));
        this.classList.add("selected");
        userNametagColor = this.dataset.color;
    });
});

document.querySelectorAll(".public-effect-preview").forEach(effectBtn => {
    effectBtn.addEventListener("click", function() {
        document.querySelectorAll(".public-effect-preview").forEach(e => e.classList.remove("selected"));
        this.classList.add("selected");
        userEffect = this.dataset.effect;
    });
});

document.getElementById("loginPrivateBtn").onclick=loginPrivate;
document.getElementById("loginPublicBtn").onclick=loginPublic;

function loginPrivate(){
  const u=document.getElementById("username").value.trim();
  const p=document.getElementById("password").value.trim();
  if(validUsers[u] && validUsers[u].password===p){
    username=u; 
    chatType="private"; 
    userId=u+"-"+Math.random().toString(36).slice(2,7);
    privateRoom = "chatables-private";
    // Set profile data from validUsers for private chat
    userProfilePic = validUsers[u].profilePic || "https://via.placeholder.com/60/AAAAAA/FFFFFF?text=P";
    userNametagColor = validUsers[u].nametagColor || "#00eaff";
    userEffect = validUsers[u].effect || "none";

    loginScreen.style.display="none"; startChat();
  } else alert("Wrong username or password");
}

function loginPublic(){
  const u=document.getElementById("publicName").value.trim();
  if(!u) return alert("Enter name");
  username=u; 
  chatType="public"; 
  userId=u+"-"+Math.random().toString(36).slice(2,7);
  // Profile data already set by input fields and selections for public chat

  // Save public user data to localStorage
  localStorage.setItem('publicUsername', username);
  localStorage.setItem('publicProfilePic', userProfilePic);
  localStorage.setItem('publicNametagColor', userNametagColor);
  localStorage.setItem('publicEffect', userEffect);

  publicScreen.style.display="none"; startChat();
}

document.addEventListener("keydown", e=>{
  if(e.key==="Enter"){
    if(loginScreen.style.display==="flex") loginPrivate();
    if(publicScreen.style.display==="flex") loginPublic();
    if(chatScreen.style.display==="flex") sendMessage(); // Check chatScreen
  }
});

function startChat(){
  chatScreen.style.display="flex";
  // Hide settings button for private chat
  document.getElementById("settingsBtn").style.display = (chatType === "public") ? "block" : "none";

  $("#msg").emojioneArea({pickerPosition:"top",events:{keyup:function(e){if(e.key==="Enter") sendMessage();}}});
  const onlineRef=db.ref("chatables-online/"+chatType+"/"+userId);
  // Store profile data in online presence
  onlineRef.set({
      name:username, 
      profilePic: userProfilePic, 
      nametagColor: userNametagColor, 
      effect: userEffect
  }); 
  onlineRef.onDisconnect().remove();
  listenMessages(); listenOnline();
}

function sendMessage(){
  const msgBox=$("#msg").data("emojioneArea");
  if(!msgBox) return;
  const text=msgBox.getText().trim();
  if(!text) return;
  const path = chatType==="private" ? privateRoom : "chatables-"+chatType;
  // Include profile data in message
  db.ref(path).push({
      text,
      user:userId,
      name:username,
      profilePic: userProfilePic,
      nametagColor: userNametagColor,
      effect: userEffect,
      time:Date.now()
  });
  msgBox.setText("");
}

function listenMessages(){
  const path = chatType==="private" ? privateRoom : "chatables-"+chatType;
  db.ref(path).on("child_added", snap=>{
    const d=snap.val(); if(!d) return;
    const me = d.user === userId;
    const date = new Date(d.time);
    let hours = date.getHours(); const minutes=String(date.getMinutes()).padStart(2,'0');
    const ampm=hours>=12?'PM':'AM'; hours=hours%12||12;
    const timeStr=`${hours}:${minutes} ${ampm}`;

    // Get profile details, use defaults if not present
    const senderProfilePic = d.profilePic || "https://via.placeholder.com/60/AAAAAA/FFFFFF?text=U";
    const senderNametagColor = d.nametagColor || (me ? "#007bff" : "#28a745");
    const senderEffect = d.effect || "none";

    const profilePicHtml = `<img src="${senderProfilePic}" alt="Profile" class="profile-pic effect-${senderEffect}">`;
    const nametagHtml = `<b class="nametag" style="color:${senderNametagColor};">${me ? "You" : d.name}</b>`;

    $("#messages").append(`
        <div class="chat-row ${me ? "you" : "friend"}">
            ${me ? '' : profilePicHtml} <!-- Profile pic on left for friends -->
            <div class="chat-bubble ${me?"message-you":"message-friend"}">
                ${nametagHtml} <span class="timestamp">${timeStr}</span><br>${d.text}
            </div>
            ${me ? profilePicHtml : ''} <!-- Profile pic on right for you -->
        </div>
    `);
    document.getElementById("messages").scrollTop=document.getElementById("messages").scrollHeight;
  });
}

function listenOnline(){
  db.ref("chatables-online/"+chatType).on("value", snap=>{
    const val = snap.val()||{}; $("#onlineUsers").html("");
    Object.entries(val).forEach(([id,v])=>{
      const isSelf = id===userId;
      const onlineProfilePic = v.profilePic || "https://via.placeholder.com/30/AAAAAA/FFFFFF?text=U";
      const onlineNametagColor = v.nametagColor || (isSelf ? "#007bff" : "#28a745");
      const onlineEffect = v.effect || "none";

      $("#onlineUsers").append(`
        <div class="online-user ${isSelf?"self":""}">
            <div class="online-dot"></div>
            <img src="${onlineProfilePic}" alt="Profile" class="profile-pic effect-${onlineEffect}">
            <span style="color:${onlineNametagColor}; font-weight:bold;">${v.name}</span>
        </div>
      `);
    });
  });
}

document.getElementById("clearBtn").onclick=()=>{
  if(confirm("Clear chat for everyone?")){
    const path = chatType==="private"?privateRoom:"chatables-"+chatType;
    db.ref(path).remove(); $("#messages").html("");
  }
}

// ---------------- Settings Screen Logic ----------------
document.getElementById("settingsBtn").onclick = () => {
    chatScreen.style.display = "none";
    settingsScreen.style.display = "flex";
    // Populate settings screen with current user data
    updateProfileOptionsUI("settings", userProfilePic, userNametagColor, userEffect);
};

// Event listeners for settings profile options (similar to public screen)
document.getElementById("settingsProfilePicUrl").addEventListener("input", function() {
    const url = this.value.trim();
    document.getElementById("settingsProfilePicPreview").src = url || "https://via.placeholder.com/60/00eaff/000000?text=P";
});

document.querySelectorAll(".settings-color-swatch").forEach(swatch => {
    swatch.addEventListener("click", function() {
        document.querySelectorAll(".settings-color-swatch").forEach(s => s.classList.remove("selected"));
        this.classList.add("selected");
    });
});

document.querySelectorAll(".settings-effect-preview").forEach(effectBtn => {
    effectBtn.addEventListener("click", function() {
        document.querySelectorAll(".settings-effect-preview").forEach(e => e.classList.remove("selected"));
        this.classList.add("selected");
    });
});

document.getElementById("saveSettingsBtn").onclick = () => {
    // Get new values from settings screen
    const newProfilePic = document.getElementById("settingsProfilePicUrl").value.trim() || "https://via.placeholder.com/60/00eaff/000000?text=P";
    const newNametagColor = document.querySelector(".settings-color-swatch.selected")?.dataset.color || "#00eaff";
    const newEffect = document.querySelector(".settings-effect-preview.selected")?.dataset.effect || "none";

    // Update global user variables
    userProfilePic = newProfilePic;
    userNametagColor = newNametagColor;
    userEffect = newEffect;

    // Update localStorage for public chat persistence
    localStorage.setItem('publicProfilePic', userProfilePic);
    localStorage.setItem('publicNametagColor', userNametagColor);
    localStorage.setItem('publicEffect', userEffect);

    // Update Firebase online presence immediately
    const onlineRef = db.ref("chatables-online/"+chatType+"/"+userId);
    onlineRef.update({
        profilePic: userProfilePic,
        nametagColor: userNametagColor,
        effect: userEffect
    });

    // Go back to chat screen
    settingsScreen.style.display = "none";
    chatScreen.style.display = "flex";
};

document.getElementById("cancelSettingsBtn").onclick = () => {
    settingsScreen.style.display = "none";
    chatScreen.style.display = "flex";
};

// Background particles
for(let i=0;i<100;i++){
  const p=document.createElement("div"); p.className="particle"; 
  p.style.left=Math.random()*100+"%"; p.style.top=Math.random()*100+"%"; 
  p.style.animationDuration=(6+Math.random()*5)+"s"; p.style.animationDelay=(Math.random()*7)+"s"; 
  document.body.appendChild(p);
}

// ---------------- Custom Cursor Script ----------------
(() => {
  const cursor = document.querySelector('.target-cursor-wrapper');
  const dot = cursor.querySelector('.target-cursor-dot');
  const corners = Array.from(cursor.querySelectorAll('.target-cursor-corner'));

  const cornerSize = 12;
  const borderWidth = 3;
  const baseTransforms = [
    { x: -1.5 * cornerSize, y: -1.5 * cornerSize },
    { x: 0.5 * cornerSize, y: -1.5 * cornerSize },
    { x: 0.5 * cornerSize, y: 0.5 * cornerSize },
    { x: -1.5 * cornerSize, y: 0.5 * cornerSize }
  ];

  let cursorPos = { x: window.innerWidth / 2, y: window.innerHeight / 2 };
  let activeTarget = null;
  let targetCorners = null;
  let activeStrength = { current: 0 };
  let isActive = false;

  gsap.set(cursor, { x: cursorPos.x, y: cursorPos.y, xPercent: -50, yPercent: -50 });
  corners.forEach((c, i) => gsap.set(c, baseTransforms[i]));
  gsap.set(dot, { scale: 1 });

  let spinTl = gsap.timeline({ repeat: -1, defaults: { ease: 'none' } })
    .to(cursor, { rotation: '+=360', duration: 2 });

  window.addEventListener('mousemove', e => {
    cursorPos.x = e.clientX; cursorPos.y = e.clientY;
    gsap.to(cursor, { x: cursorPos.x, y: cursorPos.y, duration: 0.1, ease: 'power3.out' });
    if (isActive) updateCorners(e.clientX, e.clientY);
  });

  window.addEventListener('mousedown', () => {
    gsap.to(dot, { scale: 0.7, duration: 0.2 });
    gsap.to(cursor, { scale: 0.9, duration: 0.2 });
  });
  window.addEventListener('mouseup', () => {
    gsap.to(dot, { scale: 1, duration: 0.2 });
    gsap.to(cursor, { scale: 1, duration: 0.2 });
  });

  function updateCorners(mouseX, mouseY){
    if(!isActive||!targetCorners) return;
    const strength = activeStrength.current;
    corners.forEach((corner, i)=>{
      const targetX = targetCorners[i].x - mouseX + baseTransforms[i].x;
      const targetY = targetCorners[i].y - mouseY + baseTransforms[i].y;
      const currentX = gsap.getProperty(corner,'x');
      const currentY = gsap.getProperty(corner,'y');
      gsap.set(corner,{ x: currentX + (targetX-currentX)*strength, y: currentY + (targetY-currentY)*strength });
    });
  }

  function cleanupTarget(target){ if(target) target.removeEventListener('mouseleave', onLeave); }

  function onLeave(){
    isActive=false; targetCorners=null;
    gsap.to(activeStrength,{ current:0, duration:0.2, ease:'power2.out' });
    cleanupTarget(activeTarget); activeTarget=null;
    corners.forEach((corner,i)=>{ gsap.to(corner,{ x: baseTransforms[i].x, y: baseTransforms[i].y, duration:0.3, ease:'power3.out' }); });
    const currentRotation = gsap.getProperty(cursor,'rotation') % 360;
    spinTl.kill();
    spinTl = gsap.timeline({ repeat:-1, defaults:{ease:'none'} });
    spinTl.to(cursor,{ rotation: currentRotation + 360, duration: 2 * (1 - currentRotation/360) });
    spinTl.to(cursor,{ rotation: '+=360', duration:2, repeat:-1 });
  }

  document.querySelectorAll('.cursor-target').forEach(target=>{
    target.addEventListener('mouseenter', ()=>{
      if(activeTarget===target) return;
      activeTarget=target; isActive=true;
      const rect=target.getBoundingClientRect();
      targetCorners=[
        { x: rect.left - borderWidth, y: rect.top - borderWidth },
        { x: rect.right + borderWidth - cornerSize, y: rect.top - borderWidth },
        { x: rect.right + borderWidth - cornerSize, y: rect.bottom + borderWidth - cornerSize },
        { x: rect.left - borderWidth, y: rect.bottom + borderWidth - cornerSize }
      ];
      gsap.killTweensOf(corners);
      spinTl.pause();
      gsap.set(cursor,{ rotation:0 });
      gsap.to(activeStrength,{ current:1, duration:0.2, ease:'power2.out' });
      const cursorX = gsap.getProperty(cursor,'x'); const cursorY = gsap.getProperty(cursor,'y');
      corners.forEach((corner,i)=>{ gsap.to(corner,{ x: targetCorners[i].x - cursorX + baseTransforms[i].x, y: targetCorners[i].y - cursorY + baseTransforms[i].y, duration:0.2, ease:'power2.out' }); });
      target.addEventListener('mouseleave', onLeave);
    });
  });
})();
</script>
</body>
</html>
